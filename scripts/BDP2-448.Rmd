---
title: "BDP2-448 Lovasz"
date: "`r Sys.Date()`"
author: Benjamin Chan (chanb@ohsu.edu)
output:
  html_document:
    toc: true
    theme: simplex
---

```{r, echo = FALSE, results = "hide", message = FALSE, warning = FALSE}
library("checkpoint")
checkpoint("2019-01-01")
library("magrittr")
library("tidyverse")
library("readxl")
library("broom")
library("knitr")
library("svglite")
library("lme4")
library("broom.mixed")
```

# Import data

```{r}
getwd()
f <- "../data/raw/Becky-Bedding Exposure Study Data for Stats.2.xlsx"
```

Import data file *`r f`*

```{r}
df <- f %>% read_excel()
oldnames <- names(df)
newnames <- c("id",
              "sex",
              "time",
              "bedding",
              "order",
              "room",
              "foodIntakeNormalized",
              "orts",
              "foodIntakeRaw",
              "cumulativeFoodIntakeNormalized")
names(df) <- newnames
data.frame(oldnames, newnames) %>% kable()
```

Plot data.

```{r}
G <-
  df %>%
  ggplot() +
  aes(x = time, y = foodIntakeNormalized, group = id, color = bedding) +
  geom_line(alpha = 1/4) +
  facet_wrap(~ bedding) +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous("Time\n(hours)", breaks = c(2, 4, 12, 24, 36, 48)) +
  scale_y_continuous("Food intake, normalized\n(mg food/g body weight)") +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank())
ggsave("../figures/lineplot.png", width = 7, height = 4, dpi = 300)
ggsave("../figures/lineplot.svg", width = 7, height = 4, dpi = 300)
```

```{r lineplot, fig.height = 4}
G
```


# Setup data

```{r}
t <- 36
```

Reshape data to mouse-level analytic data set.
Data point at t = `r t` is used to evaluate difference between A and B bedding types.

Outcome variable is `diff`,
which is the difference between normalized food intake at t = `r t` under A-B bedding types.

* Positive values indicate the mouse ate more at t = `r t` with bedding type A
* Negative values indicate the mouse ate more at t = `r t` with bedding type B

```{r}
dfA <-
  df %>%
  filter(time == t) %>%
  filter(bedding == "A") %>%
  select(id, foodIntakeNormalized) %>%
  rename(A = foodIntakeNormalized)
dfB <-
  df %>%
  filter(time == t) %>%
  filter(bedding == "B") %>%
  select(id, foodIntakeNormalized) %>%
  rename(B = foodIntakeNormalized)
dfDiff <-
  merge(dfA, dfB, by = "id") %>%
  mutate(diff = A - B)
covariates <-
  df %>%
  filter(order == 1) %>%
  select(id, sex, order, bedding, room) %>%
  unique() %>%
  mutate(isBeddingAFirst = order == 1 & bedding == "A")
dfDiff <-
  merge(dfDiff, covariates, by = "id") %>%
  select(-c(order, bedding))
```

Exploratory comparisons.

```{r}
dfDiff %>%
  group_by(sex) %>%
  summarize(n = n(), mean = mean(diff), sd = sd(diff)) %>%
  kable(digits = 1)
dfDiff %>%
  group_by(room) %>%
  summarize(n = n(), mean = mean(diff), sd = sd(diff)) %>%
  kable(digits = 1)
dfDiff %>%
  group_by(isBeddingAFirst) %>%
  summarize(n = n(), mean = mean(diff), sd = sd(diff)) %>%
  kable(digits = 1)
```


# Model A-B difference at t = `r t`

```{r}
M <- lm(diff ~ 1, data = dfDiff) 
M %>% tidy() %>% kable(digits = 3)
```

There appears to be **no** significant difference in the amount of food intake at t = `r t`.
Normalized food intake is higher with bedding type B by
`r M %>% tidy() %>% pull(estimate) %>% abs() %>% sprintf("%.3g", .)` mg/g
(p-value = `r M %>% tidy() %>% pull(p.value) %>% sprintf("%.2g", .)`).

```{r}
lm(diff ~ sex, data = dfDiff) %>% tidy() %>% kable(digits = 3)
lm(diff ~ room, data = dfDiff) %>% tidy() %>% kable(digits = 3)
```

The difference is still not significant after adjusting for sex or room.

```{r}
M <- lm(diff ~ isBeddingAFirst, data = dfDiff)
M %>% tidy() %>% kable(digits = 3)
```

```{r, echo = FALSE}
betaA <- lm(diff ~ !isBeddingAFirst, data = dfDiff) %>% tidy() %>% filter(term == "(Intercept)")
betaB <- lm(diff ~  isBeddingAFirst, data = dfDiff) %>% tidy() %>% filter(term == "(Intercept)")
```

However, the difference appears to depend on which bedding type the mouse experiences first.
Mice that experience bedding type A first have higher food intakes at t = `r t` with bedding type A:
`r betaA %>% pull(estimate) %>% abs() %>% sprintf("%.3g", .)` mg/g
(p-value = `r betaA %>% pull(p.value) %>% sprintf("%.2g", .)`)
Mice that experience bedding type B first have higher food intakes at t = `r t` with bedding type B:
`r betaB %>% pull(estimate) %>% abs() %>% sprintf("%.3g", .)` mg/g
(p-value = `r betaB %>% pull(p.value) %>% sprintf("%.2g", .)`)

This suggests that a crossover design might not be the most optimal study design for this research question.

An alternative analysis is to assume a model that ignores the cross-sectional study design.
Instead, the model includes `order` as a fixed effect and an interaction between `bedding` and `order`.
The model also includes a random intercept effect for mouse.


# Model normalized food intake at t = `r t`

This model is a longitudinal model where each mouse contributes 2 data points,
one for each bedding type (A, B).
The model includes an `order` effect and an interaction between `bedding` and `order`.

```{r}
dfRanEff <-
  df %>%
  filter(time == t) %>%
  select(id, foodIntakeNormalized, order, bedding, sex, room) %>%
  mutate(order = factor(order))
dfRanEff %>%
  group_by(order, bedding) %>%
  summarize(n = n(), mean = mean(foodIntakeNormalized), sd = sd(foodIntakeNormalized)) %>%
  kable(digits = 1)
```

A t = `r t`, normalized food intake for the mice under bedding type A is almost identical to the mice under bedding type B at the start of the experiment (`order` = 1).
After crossover (`order` = 2) there is a slightly lower normalized food intake among the mice under bedding type A compared to bedding type B.

```{r}
dfRanEff <-
  dfRanEff %>%
  mutate(orderRev = factor(order, levels = c(2, 1)))
M <-
  lmer(foodIntakeNormalized ~ bedding + orderRev + bedding * orderRev + (1 | id), 
       data = dfRanEff)
M %>% 
  tidy(conf.int = TRUE, effects = "fixed") %>% 
  mutate(pvalue = pt(statistic, df = 1, lower.tail = FALSE)) %>% 
  kable(digits = 3)
```

```{r, echo = FALSE}
betaB <- M %>% tidy() %>% filter(term == "beddingB")
```

After crossover, mice under bedding type B had higher normalized food intake compared to bedding type A:
`r betaB %>% pull(estimate) %>% sprintf("%.3g", .)` mg/g
(p-value = `r betaB %>% pull(statistic) %>% pt(df = 1, lower.tail = FALSE) %>% sprintf("%.2g", .)`)

```{r, echo = FALSE}
M <-
  lmer(foodIntakeNormalized ~ bedding + order + bedding * order + (1 | id), 
       data = dfRanEff)
betaB <- M %>% tidy() %>% filter(term == "beddingB")
```

Before crossover, there was virtually no difference between normalized food intake by bedding type:
`r betaB %>% pull(estimate) %>% sprintf("%.3g", .)` mg/g
(p-value = `r betaB %>% pull(statistic) %>% pt(df = 1, lower.tail = FALSE) %>% sprintf("%.2g", .)`)


# R session information

For debugging purposes.

```{r, echo = FALSE}
sprintf("Run time: %s", Sys.time())
print(sessionInfo(), locale = FALSE)
```
